pipeline {
    agent {
        kubernetes {
            label 'onPR'
            yaml '''
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: android-sdk
    image: eclipsekeyple/java-builder:1
    command: ["/usr/local/bin/uid_entrypoint"]
    args: ["cat"]
    tty: true
    volumeMounts:
    - name: volume-known-hosts
      mountPath: /home/jenkins/.ssh
    - name: "jenkins-home"
      mountPath: "/home/jenkins"
      readOnly: false
    - name: "gradle-home"
      mountPath: "/home/jenkins/.gradle"
      readOnly: false
  volumes:
  - name: volume-known-hosts
    configMap:
      name: known-hosts
  - name: "jenkins-home"
    emptyDir:
      medium: ""
  - name: "gradle-home"
    emptyDir:
      medium: ""

'''
        }
    }

    environment {
        JVM_OPTS= '-Xmx3200m'
        ANDROID_HOME=  '/opt/android-sdk-linux'
    }

    stages {

        stage('Prepare'){
            steps{
                container('android-sdk') {
                    echo "branch to be merge : ${ghprbSourceBranch}"
                    //clone branch
                    git branch: '${ghprbSourceBranch}', url: 'https://github.com/eclipse/keyple-java.git'
                    sh 'gradle wrapper --gradle-version 4.5.1'
                }
            }
        }

        stage('Execute tests') {
            steps{
                container('android-sdk') {
                    sh './gradlew :java:component:keyple-core:uploadArchives --info'
                    sh './gradlew :java:component:keyple-calypso:uploadArchives --info'
                    sh './gradlew :java:component:keyple-plugin:keyple-plugin-pcsc:uploadArchives --info'
                    sh './gradlew :java:component:keyple-plugin:keyple-plugin-remotese:uploadArchives --info'
                    sh './gradlew :java:component:keyple-plugin:keyple-plugin-stub:uploadArchives --info'
                    sh './gradlew check --info'

                    //android
                    sh './gradlew -b ./android/build.gradle :keyple-plugin:keyple-plugin-android-nfc:check'
                    sh './gradlew -b ./android/build.gradle :keyple-plugin:keyple-plugin-android-omapi:check'

                    //examples
                    sh './gradlew -b java/example/calypso/remotese/build.gradle check'



                }
            }
        }

    }
}