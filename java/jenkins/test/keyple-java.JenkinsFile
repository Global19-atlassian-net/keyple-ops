pipeline {
    agent {
        kubernetes {
            label 'keyple-java_TEST'
            yaml '''
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: java-builder
    image: eclipsekeyple/java-builder:1
    command: ["/usr/local/bin/uid_entrypoint"]
    args: ["cat"]
    tty: true
    resources:
      requests:
        cpu: 250m
        memory: 1Gi
      limits:
        cpu: 1
        memory: 2Gi
    volumeMounts:
    - name: volume-known-hosts
      mountPath: /home/jenkins/.ssh
    - name: "jenkins-home"
      mountPath: "/home/jenkins"
      readOnly: false
    - name: "gradle-home"
      mountPath: "/home/jenkins/.gradle"
      readOnly: false
  volumes:
  - name: volume-known-hosts
    configMap:
      name: known-hosts
  - name: "jenkins-home"
    emptyDir:
      medium: ""
  - name: "gradle-home"
    emptyDir:
      medium: ""

'''
        }
    }

    environment {
        GRADLE_USER_HOME = '/home/jenkins/.gradle/'
    }

    stages {

        stage('Prepare'){
            steps{
                container('java-builder') {
                    echo "branch to be merge : ${ghprbSourceBranch}"
                    git branch: '${ghprbSourceBranch}', url: 'https://github.com/eclipse/keyple-java.git'
                    sh 'gradle wrapper --gradle-version 4.5.1'
                    sh 'echo "org.gradle.daemon=true" > /home/jenkins/.gradle/gradle.properties'
                    sh 'echo "org.gradle.parallel=false" >> /home/jenkins/.gradle/gradle.properties'
                    sh 'echo "org.gradle.jvmargs=-Xmx1800m -XX:MaxPermSize=512m -Dfile.encoding=UTF-8 -XX:+HeapDumpOnOutOfMemoryError" >> /home/jenkins/.gradle/gradle.properties'
                }
            }
        }

        stage('Execute tests') {
            steps{
                container('java-builder') {
                    sh './gradlew :java:component:keyple-core:uploadArchives --info'
                    sh './gradlew :java:component:keyple-calypso:uploadArchives --info'
                    sh './gradlew :java:component:keyple-plugin:keyple-plugin-pcsc:uploadArchives --info'
                    sh './gradlew :java:component:keyple-plugin:keyple-plugin-remotese:uploadArchives --info'
                    sh './gradlew :java:component:keyple-plugin:keyple-plugin-stub:uploadArchives --info'
                    sh './gradlew check --info'

                    //android
                    sh './gradlew -b ./android/build.gradle :keyple-plugin:keyple-plugin-android-nfc:check'
                    sh './gradlew -b ./android/build.gradle :keyple-plugin:keyple-plugin-android-omapi:check'

                    //examples
                    sh './gradlew -b java/example/calypso/remotese/build.gradle check'

                }
            }
        }
    }
}